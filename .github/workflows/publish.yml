name: Publish to NPM

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Update npm
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Smart Publish Logic
        run: |
          # 1. Get package name and local version from package.json
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          LOCAL_VERSION=$(node -p "require('./package.json').version")
          
          # 2. Get the latest version already published on NPM
          # If the package is new, we fallback to 0.0.0
          REMOTE_VERSION=$(npm view $PACKAGE_NAME version 2>/dev/null || echo "0.0.0")
          
          echo "Local Version: $LOCAL_VERSION"
          echo "Remote (NPM) Version: $REMOTE_VERSION"

          # 3. Compare versions
          if [ "$LOCAL_VERSION" != "$REMOTE_VERSION" ]; then
            echo "üöÄ Version bump detected ($REMOTE_VERSION -> $LOCAL_VERSION). Publishing to LATEST..."
            npm publish --provenance
          else
            echo "üõ†Ô∏è No version bump. Publishing daily build to DEV tag..."
            # Create timestamped dev version: e.g. 2.0.0-dev.202402121530
            DEV_VERSION="${LOCAL_VERSION}-dev.$(date +%Y%m%d%H%M%S)"
            npm version $DEV_VERSION --no-git-tag-version
            npm publish --tag dev --provenance
          fi
